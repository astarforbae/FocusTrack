{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* 卡片样式 */
    .stats-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
        margin-bottom: 20px;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .stats-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    .stats-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    /* 图表容器 */
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    
    /* 表格样式 */
    .focus-table th, .focus-table td {
        vertical-align: middle;
    }
    .focus-duration {
        font-weight: 600;
        color: #0d6efd;
    }
    
    /* 日期选择器样式 */
    .date-picker-container {
        position: relative;
        max-width: 300px;
    }
    .date-picker-container .input-group-text {
        background-color: #0d6efd;
        color: white;
        border: none;
    }
    .flatpickr-input {
        border-radius: 0 0.25rem 0.25rem 0 !important;
    }
    
    /* 删除按钮样式 */
    .btn-delete-session {
        color: #dc3545;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-delete-session:hover {
        color: #bd2130;
        transform: scale(1.1);
    }
    
    /* 确认对话框样式 */
    .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
    }
    .confirm-dialog.show {
        opacity: 1;
        visibility: visible;
    }
    .confirm-dialog-content {
        background-color: white;
        border-radius: 5px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
    }
    .confirm-dialog-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
    }
    .confirm-dialog-message {
        margin-bottom: 20px;
    }
    .confirm-dialog-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>专注历史</h2>
        
        <!-- 日期选择器 -->
        <div class="date-picker-container">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-calendar3"></i>
                </span>
                <input type="text" class="form-control" id="date-picker" placeholder="选择日期" value="{{ date }}">
            </div>
        </div>
    </div>
    
    <!-- 第一部分：统计摘要 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card bg-primary bg-opacity-10 h-100">
                <div class="card-body text-center">
                    <div class="stats-icon text-primary">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="stats-number text-primary">{{ total_focus_time_str }}</div>
                    <div class="stats-label">总专注时长</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-success bg-opacity-10 h-100">
                <div class="card-body text-center">
                    <div class="stats-icon text-success">
                        <i class="bi bi-list-task"></i>
                    </div>
                    <div class="stats-number text-success">{{ total_tasks }}</div>
                    <div class="stats-label">专注任务数</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-info bg-opacity-10 h-100">
                <div class="card-body text-center">
                    <div class="stats-icon text-info">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    <div class="stats-number text-info">{{ completed_tasks }}</div>
                    <div class="stats-label">已完成任务数</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 第二部分：可视化图表 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">专注时间分布</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="pie-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">时间轴</h5>
                </div>
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <div class="mb-3 text-center">
                        <i class="bi bi-clock-history text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="mb-3 text-center">查看专注时间轴</h5>
                    <p class="text-muted text-center mb-4">在详细时间轴视图中可以直观地查看一天中所有专注活动的分布</p>
                    <a href="/timeline?date={{ date }}" class="btn btn-primary">
                        <i class="bi bi-fullscreen me-2"></i> 查看详细时间轴
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 第三部分：专注数据表格 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">专注详细数据</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover focus-table" id="focus-table">
                    <thead>
                        <tr>
                            <th>任务名称</th>
                            <th>开始时间</th>
                            <th>结束时间</th>
                            <th>专注时长</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="focus-table-body">
                        <!-- 表格数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 无数据提示 -->
    <div id="no-data-alert" class="alert alert-info text-center" style="display: none;">
        <i class="bi bi-info-circle me-2"></i> 当前日期没有专注记录。
    </div>
</div>

<!-- 确认删除对话框 -->
<div id="confirm-delete-dialog" class="confirm-dialog">
    <div class="confirm-dialog-content">
        <div class="confirm-dialog-title">确认删除</div>
        <div class="confirm-dialog-message">确定要删除这条专注记录吗？此操作不可撤销。</div>
        <div class="confirm-dialog-buttons">
            <button id="cancel-delete-btn" class="btn btn-secondary">取消</button>
            <button id="confirm-delete-btn" class="btn btn-danger">删除</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 全局变量
    let tasks = {{ tasks | tojson }};
    let chartData;
    
    try {
        chartData = JSON.parse('{{ chart_data | safe }}');
        
        // 调试输出每个任务的属性
        if (chartData && chartData.length > 0) {
            console.log("Chart Data 第一项属性:");
            for (const key in chartData[0]) {
                console.log(`- ${key}: ${chartData[0][key]}`);
            }
        }
    } catch (e) {
        console.error("Error parsing JSON data:", e);
        chartData = [];
    }
    
    let pieChart = null;
    let currentSessionId = null; // 当前要删除的会话ID
    
    // 调试信息
    console.log("Tasks:", tasks);
    console.log("Chart Data:", chartData);
    
    // 格式化时间为 hh:mm:ss 格式
    function formatTimeHMS(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化Flatpickr日期选择器
        const datePicker = flatpickr("#date-picker", {
            dateFormat: "Y-m-d",
            locale: "zh",
            defaultDate: "{{ date }}" || new Date(),
            onChange: function(selectedDates, dateStr) {
                window.location.href = `/focus_history?date=${dateStr}`;
            }
        });
        
        // 处理并显示数据
        processAndDisplayData();
        
        // 初始化确认删除对话框
        initDeleteDialog();
    });
    
    // 处理并显示所有数据
    function processAndDisplayData() {
        console.log("开始处理数据...");
        
        // 检查任务数据
        if (!tasks || tasks.length === 0) {
            console.log("没有任务数据");
            document.getElementById('no-data-alert').style.display = 'block';
            return;
        }
        
        console.log(`任务数据: ${tasks.length} 个任务`);
        
        try {
            // 生成饼图
            generatePieChart();
            
            // 填充表格数据
            populateTable();
            
            console.log("数据处理完成");
        } catch (error) {
            console.error("处理数据时出错:", error);
            document.getElementById('no-data-alert').style.display = 'block';
        }
    }
    
    // 生成饼图
    function generatePieChart() {
        // 检查是否有数据
        if (!chartData || chartData.length === 0) {
            console.log("没有饼图数据可显示");
            return;
        }
        
        console.log("生成饼图，数据:", chartData);
        
        // 计算总专注时间
        const totalTime = chartData.reduce((sum, item) => sum + item.time, 0);
        
        // 准备饼图数据
        const labels = [];
        const data = [];
        const colors = [];
        const taskNames = [];
        
        // 为每个任务准备数据
        chartData.forEach(item => {
            // 确保任务名称存在
            const taskName = item.task || "未命名任务";
            taskNames.push(taskName);
            
            // 计算百分比
            const percentage = ((item.time / totalTime) * 100).toFixed(1);
            
            // 格式化时间显示 (hh:mm:ss)
            const timeStr = formatTimeHMS(item.time);
            
            console.log(`任务: ${taskName}, 时间: ${item.time}, 格式化时间: ${timeStr}, 百分比: ${percentage}%`);
            
            // 添加到数据数组
            labels.push(`${taskName} (${percentage}%, ${timeStr})`);
            data.push(item.time);
            colors.push(item.color || "#4e73df");
        });
        
        // 创建饼图
        const ctx = document.getElementById('pie-chart').getContext('2d');
        if (pieChart) {
            pieChart.destroy();
        }
        
        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: taskNames, // 只使用任务名称作为原始标签
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            generateLabels: function(chart) {
                                // 获取默认标签
                                const original = Chart.overrides.pie.plugins.legend.labels.generateLabels(chart);
                                
                                // 自定义每个标签
                                return original.map((label, i) => {
                                    if (i < taskNames.length && i < data.length) {
                                        const value = data[i];
                                        const percentage = ((value / totalTime) * 100).toFixed(1);
                                        const timeStr = formatTimeHMS(value);
                                        
                                        // 更新标签文本
                                        label.text = `${taskNames[i]} (${percentage}%, ${timeStr})`;
                                    }
                                    return label;
                                });
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const index = context.dataIndex;
                                
                                // 计算百分比
                                const percentage = ((value / totalTime) * 100).toFixed(1);
                                
                                // 格式化时间为 hh:mm:ss
                                const timeStr = formatTimeHMS(value);
                                
                                // 使用存储的任务名称
                                if (index < taskNames.length) {
                                    return `${taskNames[index]}: ${timeStr} (${percentage}%)`;
                                } else {
                                    return `未知任务: ${timeStr} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 填充表格数据
    function populateTable() {
        const tableBody = document.getElementById('focus-table-body');
        tableBody.innerHTML = '';
        
        // 遍历所有任务和会话
        tasks.forEach(task => {
            if (!task.sessions || task.sessions.length === 0) return;
            
            task.sessions.forEach(session => {
                const row = document.createElement('tr');
                
                // 任务名称单元格
                const taskCell = document.createElement('td');
                taskCell.textContent = task.title;
                
                // 添加彩色标记
                const colorMark = document.createElement('span');
                colorMark.style.display = 'inline-block';
                colorMark.style.width = '12px';
                colorMark.style.height = '12px';
                colorMark.style.borderRadius = '50%';
                
                // 查找任务对应的颜色
                let taskColor = '#4e73df';
                if (chartData && chartData.length > 0) {
                    const taskItem = chartData.find(item => item.task === task.title);
                    if (taskItem && taskItem.color) {
                        taskColor = taskItem.color;
                    }
                }
                colorMark.style.backgroundColor = taskColor;
                colorMark.style.marginRight = '8px';
                
                taskCell.prepend(colorMark);
                row.appendChild(taskCell);
                
                // 开始时间单元格
                const startCell = document.createElement('td');
                startCell.textContent = session.start_time;
                row.appendChild(startCell);
                
                // 结束时间单元格
                const endCell = document.createElement('td');
                endCell.textContent = session.end_time || '进行中';
                row.appendChild(endCell);
                
                // 专注时长单元格
                const durationCell = document.createElement('td');
                durationCell.className = 'focus-duration';
                durationCell.textContent = session.duration_str;
                row.appendChild(durationCell);
                
                // 状态单元格
                const statusCell = document.createElement('td');
                if (!session.end_time) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-success';
                    badge.textContent = '进行中';
                    statusCell.appendChild(badge);
                } else {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-secondary';
                    badge.textContent = '已完成';
                    statusCell.appendChild(badge);
                }
                row.appendChild(statusCell);
                
                // 操作单元格
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-link btn-delete-session p-0';
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                deleteBtn.title = '删除此专注记录';
                deleteBtn.onclick = function() {
                    showDeleteConfirmation(session.id);
                };
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        });
        
        // 如果表格为空，显示无数据提示
        if (tableBody.children.length === 0) {
            document.getElementById('no-data-alert').style.display = 'block';
        }
    }
    
    // 初始化删除确认对话框
    function initDeleteDialog() {
        const dialog = document.getElementById('confirm-delete-dialog');
        const cancelBtn = document.getElementById('cancel-delete-btn');
        const confirmBtn = document.getElementById('confirm-delete-btn');
        
        // 取消按钮
        cancelBtn.addEventListener('click', function() {
            hideDeleteConfirmation();
        });
        
        // 确认删除按钮
        confirmBtn.addEventListener('click', function() {
            if (currentSessionId) {
                deleteFocusSession(currentSessionId);
            }
        });
        
        // 点击对话框外部关闭
        dialog.addEventListener('click', function(e) {
            if (e.target === dialog) {
                hideDeleteConfirmation();
            }
        });
    }
    
    // 显示删除确认对话框
    function showDeleteConfirmation(sessionId) {
        currentSessionId = sessionId;
        const dialog = document.getElementById('confirm-delete-dialog');
        dialog.classList.add('show');
    }
    
    // 隐藏删除确认对话框
    function hideDeleteConfirmation() {
        const dialog = document.getElementById('confirm-delete-dialog');
        dialog.classList.remove('show');
        currentSessionId = null;
    }
    
    // 删除专注会话
    function deleteFocusSession(sessionId) {
        // 获取当前日期参数
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date') || '';
        
        // 发送删除请求
        fetch(`/delete_focus_session/${sessionId}?date=${dateParam}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 重新加载页面
                window.location.href = data.redirect;
            } else {
                alert('删除失败: ' + (data.error || '未知错误'));
                hideDeleteConfirmation();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败，请稍后重试');
            hideDeleteConfirmation();
        });
    }
</script>
{% endblock %}
